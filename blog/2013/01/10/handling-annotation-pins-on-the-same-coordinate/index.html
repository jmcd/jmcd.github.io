
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Handling MKMapView Annotation Pins on the Same Coordinate - jmcd.io</title>
  <meta name="author" content="John McDowall">

  
  <meta name="description" content="A component of a project I am working on displays shop locations on a map. A problem arises when the shops are located at a shopping centre or mall &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jmcd.io/blog/2013/01/10/handling-annotation-pins-on-the-same-coordinate/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="jmcd.io" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">jmcd.io</a></h1>
  
    <h2>John McDowall</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://www.duckduckgo.com/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="jmcd.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Handling MKMapView Annotation Pins on the Same Coordinate</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-01-10T00:00:00+00:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>A component of a project I am working on displays shop locations on a map. A problem arises when the shops are located at a shopping centre or mall - the shops are invariably geo-coded to the same latitude-longitude coordinates.</p>

<p>When the shops have the same coordinates, the annotations (pins) display in the exact same location on the map. This gives the appearance of there only being one pin, and indeed, the user can only tap one pin.</p>

<p>To overcome this, we implemented a routine to re-place the pins at new coordinates surrounding the contested coordinate.</p>

<p><img src="/img/Screen-Shot-2013-01-10-at-14.32.11.png" title="pins surrounding coord" ></p>

<p><em>tl;dr get the full <a href="https://gist.github.com/4502302">code</a>.</em></p>

<p>First we group the annotations by coordinate.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="bp">MKAnnotation</span><span class="o">&gt;</span> <span class="n">pin</span> <span class="k">in</span> <span class="n">annotations</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CLLocationCoordinate2D</span> <span class="n">coordinate</span> <span class="o">=</span> <span class="n">pin</span><span class="p">.</span><span class="n">coordinate</span><span class="p">;</span>
</span><span class='line'>    <span class="bp">NSValue</span> <span class="o">*</span><span class="n">coordinateValue</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSValue</span> <span class="nl">valueWithBytes</span><span class="p">:</span><span class="o">&amp;</span><span class="err">#</span><span class="mo">03</span><span class="mi">8</span><span class="p">;</span><span class="n">coordinate</span> <span class="nl">objCType</span><span class="p">:</span><span class="k">@encode</span><span class="p">(</span><span class="n">CLLocationCoordinate2D</span><span class="p">)];</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">annotationsAtLocation</span> <span class="o">=</span> <span class="n">coordinateValuesToAnnotations</span><span class="p">[</span><span class="n">coordinateValue</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">annotationsAtLocation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">annotationsAtLocation</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>        <span class="n">coordinateValuesToAnnotations</span><span class="p">[</span><span class="n">coordinateValue</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotationsAtLocation</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">annotationsAtLocation</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">pin</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This routine produces a dictionary keyed on <code>NSValue</code>s containing a copy of the coordinate (you can&rsquo;t key a <code>NSDictionary</code> on a c-type). The value of a entry in the dictionary is a <code>NSArray</code> of annotations at that coordinate.</p>

<p>You can see this only matches on exactly equal coordinates, but it would be relatively straightforward to group on coordinates that were close by calculating the distance between them.</p>

<p>Next we enumerate the dictionary looking for locations that have more than one annotation. When we find one, we reposition the annotations.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="kt">double</span> <span class="n">distance</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">annotations</span><span class="p">.</span><span class="n">count</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>
</span><span class='line'><span class="kt">double</span> <span class="n">radiansBetweenAnnotations</span> <span class="o">=</span> <span class="p">(</span><span class="n">M_PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">annotations</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">annotations</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">double</span> <span class="n">heading</span> <span class="o">=</span> <span class="n">radiansBetweenAnnotations</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>    <span class="n">CLLocationCoordinate2D</span> <span class="n">newCoordinate</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">calculateCoordinateFrom</span><span class="p">:</span><span class="n">coordinate</span> <span class="nl">onBearing</span><span class="p">:</span><span class="n">heading</span> <span class="nl">atDistance</span><span class="p">:</span><span class="n">distance</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">id</span> <span class="o">&lt;</span><span class="bp">MKAnnotation</span><span class="o">&gt;</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>    <span class="n">annotation</span><span class="p">.</span><span class="n">coordinate</span> <span class="o">=</span> <span class="n">newCoordinate</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The pins are arranged in a circle around the contested point by dividing the circle by the number of contesting annotations. You can see that the distance from the contested coordinate to the new coordinate is a function of the number of annotations contesting - if there are few pins contesting the coordinate, then we have space to place the pins close to the coordinate.</p>

<p>Finally, the new coordinate is calculated using an implementation of the function from this excellent resource: <a href="http://www.movable-type.co.uk/scripts/latlong.html">Destination point given distance and bearing from start point</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">+</span> <span class="p">(</span><span class="n">CLLocationCoordinate2D</span><span class="p">)</span><span class="nf">calculateCoordinateFrom:</span><span class="p">(</span><span class="n">CLLocationCoordinate2D</span><span class="p">)</span><span class="nv">coordinate</span> <span class="nf">onBearing:</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="nv">bearingInRadians</span> <span class="nf">atDistance:</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="nv">distanceInMetres</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">double</span> <span class="n">coordinateLatitudeInRadians</span> <span class="o">=</span> <span class="n">coordinate</span><span class="p">.</span><span class="n">latitude</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">double</span> <span class="n">coordinateLongitudeInRadians</span> <span class="o">=</span> <span class="n">coordinate</span><span class="p">.</span><span class="n">longitude</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">double</span> <span class="n">distanceComparedToEarth</span> <span class="o">=</span> <span class="n">distanceInMetres</span> <span class="o">/</span> <span class="mi">6378100</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">double</span> <span class="n">resultLatitudeInRadians</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">coordinateLatitudeInRadians</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">distanceComparedToEarth</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">coordinateLatitudeInRadians</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">distanceComparedToEarth</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">bearingInRadians</span><span class="p">));</span>
</span><span class='line'>    <span class="kt">double</span> <span class="n">resultLongitudeInRadians</span> <span class="o">=</span> <span class="n">coordinateLongitudeInRadians</span> <span class="o">+</span> <span class="n">atan2</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">bearingInRadians</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">distanceComparedToEarth</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">coordinateLatitudeInRadians</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">distanceComparedToEarth</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">coordinateLatitudeInRadians</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">resultLatitudeInRadians</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CLLocationCoordinate2D</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="n">result</span><span class="p">.</span><span class="n">latitude</span> <span class="o">=</span> <span class="n">resultLatitudeInRadians</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">M_PI</span><span class="p">;</span>
</span><span class='line'>    <span class="n">result</span><span class="p">.</span><span class="n">longitude</span> <span class="o">=</span> <span class="n">resultLongitudeInRadians</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">M_PI</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">John McDowall</span></span>

      




<time class='entry-date' datetime='2013-01-10T00:00:00+00:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:00 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/cocoa-touch/'>cocoa touch</a>, <a class='category' href='/blog/categories/ios/'>ios</a>, <a class='category' href='/blog/categories/mkmapview/'>mkmapview</a>, <a class='category' href='/blog/categories/objective-c/'>objective-c</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://jmcd.io/blog/2013/01/10/handling-annotation-pins-on-the-same-coordinate/" data-via="" data-counturl="http://jmcd.io/blog/2013/01/10/handling-annotation-pins-on-the-same-coordinate/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/01/07/stop-it-nintendo-no-you're-hurting-me/" title="Previous Post: Stop it Nintendo, No, You're Hurting Me">&laquo; Stop it Nintendo, No, You&#8217;re Hurting Me</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/09/18/my-two-favourite-parts-of-the-ios7-sdk/" title="Next Post: My two favourite parts of the iOS 7 SDK">My two favourite parts of the iOS 7 SDK &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/03/18/method-access-modifiers-as-code-smells/">Method Access Modifiers as Code Smells</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/20/a-primer-on-bluetooth-low-energy-and-its-application-in-ios/">A Primer on Bluetooth Low Energy, and It&#8217;s Application in iOS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/18/my-two-favourite-parts-of-the-ios7-sdk/">My Two Favourite Parts of the iOS 7 SDK</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/10/handling-annotation-pins-on-the-same-coordinate/">Handling MKMapView Annotation Pins on the Same Coordinate</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/07/stop-it-nintendo-no-you're-hurting-me/">Stop It Nintendo, No, You&#8217;re Hurting Me</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - John McDowall -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
